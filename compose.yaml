services:
  web: &php
    image: tissue-dev-web
    build:
      context: .
      dockerfile: docker/development/web.dockerfile
    volumes:
      - .:/var/www/html
      - front_node_modules:/var/www/html/node_modules
    networks:
      - backend
    ports:
      - 4545:80
    depends_on:
      - db
  db:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: tissue
      POSTGRES_USER: tissue
      POSTGRES_PASSWORD: tissue
    volumes:
      - db:/var/lib/postgresql/data
      - ./docker/development/init-test-db.sql:/docker-entrypoint-initdb.d/init-test-db.sql
    networks:
      - backend
  scheduler:
    <<: *php
    command: php artisan schedule:work
    ports: []
  front:
    image: tissue-dev-web
    command: sh -c "yarn && yarn dev --host --port 4546"
    volumes:
      - .:/var/www/html
      - front_node_modules:/var/www/html/node_modules
    ports:
      - 4546:4546
    depends_on:
      - web
  antlr:
    image: tissue-antlr:4.13.1
    build:
      context: .
      dockerfile: docker/development/antlr.dockerfile
    volumes:
      - .:/app
    working_dir: /app
    profiles:
      - utility

networks:
  backend:

volumes:
  db:
  front_node_modules:
